name: Build and Release sbsh

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ 准备 dist 目录
      - name: Prepare dist directory
        run: mkdir -p dist

      # 3️⃣ 构建 sbsh for each architecture
      - name: Build sbsh for multiple architectures
        run: |
          ARCHS=("amd64" "arm64" "s390x")
          for arch in "${ARCHS[@]}"; do
            cp singbox-auto.sh "dist/sbsh-${arch}"
            chmod +x "dist/sbsh-${arch}"
            echo "$arch build done"
          done
          ls -l dist

      # 4️⃣ 上传 Release，每个架构的文件统一叫 sbsh
      - name: Create Release and upload sbsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ARCHS=("amd64" "arm64" "s390x")
          # 使用 run_number 生成合法 tag
          TAG="v${GITHUB_RUN_NUMBER}"
          # 创建 Release
          gh release create "$TAG" --title "sbsh Release $TAG" --notes "Automatic release for sbsh binaries"
          
          # 上传每个架构，统一文件名为 sbsh
          for arch in "${ARCHS[@]}"; do
            cp "dist/sbsh-${arch}" dist/sbsh
            gh release upload "$TAG" dist/sbsh --name sbsh --clobber
            echo "$arch uploaded as sbsh"
          done