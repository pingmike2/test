name: Inspect and Release sbsh

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  inspect-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Download sbsh from repo
      - name: Save sbsh from repo
        run: |
          cp ./sbsh sbsh-from-repo
          ls -l sbsh-from-repo

      # 3) Download sbsh from external URL
      - name: Download sbsh from s390x URL
        run: |
          curl -L -o sbsh-from-url "https://s390x.ssss.nyc.mn/sbsh"
          ls -l sbsh-from-url

      # 4) Check file type of both
      - name: Detect file type
        run: |
          echo "=== sbsh-from-repo type ==="
          file sbsh-from-repo
          echo ""
          echo "=== sbsh-from-url type ==="
          file sbsh-from-url

      # 5) Strings to peek inside
      - name: Peek binary strings
        run: |
          echo "=== repo sbsh strings ==="
          strings sbsh-from-repo | head -n 200
          echo ""
          echo "=== url sbsh strings ==="
          strings sbsh-from-url | head -n 200

      # 6) Upload both to Releases
      - name: Create Release and upload sbsh binaries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="inspect-sbsh-$(date +'%Y%m%d%H%M%S')"
          echo "Creating release $TAG"

          # delete old if exists
          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release delete "$TAG" -y
            git push origin ":refs/tags/$TAG"
          fi

          gh release create "$TAG" \
            sbsh-from-repo \
            sbsh-from-url \
            --title "Inspect sbsh $TAG" \
            --notes "sbsh from repo and from external URL"